pipeline {
    agent any

    tools {
        // IMPORTANT: Le nom doit correspondre EXACTEMENT à "Global Tool Configuration"
        // Si vous l'avez appelé 'maven', gardez 'maven'. Si c'est 'mvn' (comme mon guide), mettez 'mvn'.
        maven 'mvn' 
    }

    environment {
        DOCKER_IMAGE = "tp30-demo-app"
    }

    stages {
        stage('Git Clone') {
            steps {
                // Si vous utilisez "Pipeline script from SCM", cette étape est automatique.
                // Sinon, pour un script manuel :
                checkout([$class: 'GitSCM',
                    branches: [[name: 'main']],
                    userRemoteConfigs: [[url: 'https://github.com/Walid-Ahkouk/first_test_jenkis.git']]
                ])
            }
        }

        stage('Build') {
            steps {
                // IMPORTANT: On entre dans le dossier du projet
                dir('TP30-Spring-Jenkins') {
                    sh 'mvn clean package'
                }
            }
        }

        stage('Create Docker Image') {
            steps {
                dir('TP30-Spring-Jenkins') {
                    sh "docker build -t ${DOCKER_IMAGE} ."
                }
            }
        }

        stage('Run') {
            steps {
                script {
                    // Nettoyage conteneur existant
                    try {
                        sh "docker stop ${DOCKER_IMAGE}"
                        sh "docker rm ${DOCKER_IMAGE}"
                    } catch (Exception e) {
                        echo "Aucun conteneur à arrêter"
                    }

                    // Lancement
                    sh "docker run -d -p 8081:8080 --name ${DOCKER_IMAGE} ${DOCKER_IMAGE}"
                }
            }
        }
    }
}
